name: Fullstack CI/CD

on:
  push:
    branches:
      - main # Chạy khi push code vào nhánh main

jobs:
  # === Job 1: Build và Test (CI) ===
  build_and_test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Thiết lập Node.js 14.21.3 cho cả Backend và Frontend
      - name: Set up Node.js 14.21.3
        uses: actions/setup-node@v4
        with:
          node-version: '14.21.3'

      # --- Backend CI (Đã loại bỏ cd backend) ---
      - name: Install and Test Backend
        run: |
          npm install
          # npm test # Bỏ comment nếu bạn có test
        working-directory: ./backend # Chỉ dùng working-directory

      # --- Frontend Build (Đã loại bỏ cd frontend) ---
      - name: Install and Build Frontend
        run: |
          npm install
          npm run build # Lệnh build React của bạn (thường tạo ra thư mục 'build')
        working-directory: ./frontend # Chỉ dùng working-directory
      
      # Upload thư mục build của Frontend để sử dụng trong job Deploy
      - name: Upload Frontend Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/build
          retention-days: 1 # Thời gian lưu trữ artifact

  # === Job 2: Deploy (CD) ===
  deploy:
    needs: build_and_test # Đảm bảo job này chỉ chạy khi build_and_test thành công
    runs-on: ubuntu-latest
    environment: production # Môi trường triển khai (tuỳ chọn)

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # Download thư mục build của Frontend từ job trước
      - name: Download Frontend Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/build

      # Phương pháp: Chuyển thư mục build của Frontend vào thư mục Backend
      # Thư mục 'build' vừa được download sẽ nằm ở 'frontend/build'
      - name: Move Frontend Build to Backend
        run: |
          # Di chuyển các file từ 'frontend/build' vào 'backend/public/'
          rm -rf backend/public # Xóa thư mục public cũ (nếu có)
          mkdir -p backend/public # Tạo thư mục public mới
          mv frontend/build/* backend/public/ # Chuyển file
          echo "Kiểm tra cấu trúc file trong backend/public sau khi di chuyển:"
          ls -R backend/public

      # --- Deploy Backend (Node.js Web Service) ---
      # Triển khai sẽ kích hoạt Render kéo code mới nhất từ GitHub
      - name: Deploy Backend to Render
        uses: JorgeLNJunior/render-deploy@v1.4.6
        with:
          service_id: ${{ secrets.RENDER_BACKEND_SERVICE_ID }}
          api_key: ${{ secrets.RENDER_API_KEY }}
          clear_cache: true # Thêm tùy chọn này để đảm bảo Render rebuild với file Frontend mới