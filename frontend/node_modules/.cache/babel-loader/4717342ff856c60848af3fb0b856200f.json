{"ast":null,"code":"import _regeneratorRuntime from\"D:/devops/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"D:/devops/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import React,{Fragment,useEffect}from'react';import MetaData from'../layout/MetaData';import CheckoutSteps from'./CheckoutSteps';import{useAlert}from'react-alert';import{useDispatch,useSelector}from'react-redux';import{createOrder,clearErrors}from'../../actions/orderActions';import{useStripe,useElements,CardNumberElement,CardExpiryElement,CardCvcElement}from'@stripe/react-stripe-js';import axios from'axios';var options={style:{base:{fontSize:'16px'},invalid:{color:'#9e2146'}}};var Payment=function Payment(_ref){var history=_ref.history;var alert=useAlert();var stripe=useStripe();var elements=useElements();var dispatch=useDispatch();var _useSelector=useSelector(function(state){return state.auth;}),user=_useSelector.user;var _useSelector2=useSelector(function(state){return state.cart;}),cartItems=_useSelector2.cartItems,shippingInfo=_useSelector2.shippingInfo;var _useSelector3=useSelector(function(state){return state.newOrder;}),error=_useSelector3.error;useEffect(function(){if(error){alert.error(error);dispatch(clearErrors());}},[dispatch,alert,error]);// cart, ship info\nvar order={orderItems:cartItems,shippingInfo:shippingInfo};var orderInfo=JSON.parse(sessionStorage.getItem('orderInfo'));if(orderInfo){order.itemsPrice=orderInfo.itemsPrice;order.shippingPrice=orderInfo.shippingPrice;order.taxPrice=orderInfo.taxPrice;order.totalPrice=orderInfo.totalPrice;}var paymentData={amount:Math.round(orderInfo.totalPrice*100)// total price\n};var submitHandler=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(e){var res,config,clientSecret,result;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:e.preventDefault();document.querySelector('#pay_btn').disabled=true;// tìm kiếm các phần tử dựa trên id\n_context.prev=2;config={// config header type\nheaders:{'Content-Type':'application/json'}};_context.next=6;return axios.post('/api/v1/payment/process',paymentData,config);case 6:res=_context.sent;// call api paymant process\nclientSecret=res.data.client_secret;// client_secret json client\nconsole.log(clientSecret);if(!(!stripe||!elements)){_context.next=11;break;}return _context.abrupt(\"return\");case 11:_context.next=13;return stripe.confirmCardPayment(clientSecret,{// Xác thực card info\npayment_method:{card:elements.getElement(CardNumberElement),billing_details:{// chi tiết thanh toán\nname:user.name,email:user.email}}});case 13:result=_context.sent;if(result.error){alert.error(result.error.message);// return alert error\ndocument.querySelector('#pay_btn').disabled=false;// disabled btn\n}else{// Thanh toán có được xử lý hay không?\nif(result.paymentIntent.status==='succeeded'){// if success\norder.paymentInfo={// payment with info cart, shipInfo\nid:result.paymentIntent.id,status:result.paymentIntent.status};dispatch(createOrder(order));// call createOrder action\nhistory.push('/success');// return page success\n}else{alert.error('Có một số vấn đề trong khi xử lý thanh toán');}}_context.next=21;break;case 17:_context.prev=17;_context.t0=_context[\"catch\"](2);// error server\ndocument.querySelector('#pay_btn').disabled=false;alert.error(_context.t0.response.data.message);case 21:case\"end\":return _context.stop();}}},_callee,null,[[2,17]]);}));return function submitHandler(_x){return _ref2.apply(this,arguments);};}();return/*#__PURE__*/_jsxs(Fragment,{children:[/*#__PURE__*/_jsx(MetaData,{title:'Thông tin thẻ'}),/*#__PURE__*/_jsx(CheckoutSteps,{shipping:true,confirmOrder:true,payment:true}),/*#__PURE__*/_jsx(\"div\",{className:\"row wrapper\",children:/*#__PURE__*/_jsx(\"div\",{className:\"col-10 col-lg-5\",children:/*#__PURE__*/_jsxs(\"form\",{className:\"shadow-lg\",onSubmit:submitHandler,children:[/*#__PURE__*/_jsx(\"h1\",{className:\"mb-4\",children:\"Th\\xF4ng tin th\\u1EBB\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"form-group\",children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"card_num_field\",children:\"S\\u1ED1 th\\u1EBB\"}),/*#__PURE__*/_jsx(CardNumberElement,{type:\"text\",id:\"card_num_field\",className:\"form-control\",options:options})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"form-group\",children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"card_exp_field\",children:\"H\\u1EA1n th\\u1EBB\"}),/*#__PURE__*/_jsx(CardExpiryElement,{type:\"text\",id:\"card_exp_field\",className:\"form-control\",options:options})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"form-group\",children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"card_cvc_field\",children:\"S\\u1ED1 CVC\"}),/*#__PURE__*/_jsx(CardCvcElement,{type:\"text\",id:\"card_cvc_field\",className:\"form-control\",options:options})]}),/*#__PURE__*/_jsxs(\"button\",{id:\"pay_btn\",type:\"submit\",className:\"btn btn-block py-3\",children:[\"Thanh to\\xE1n \",\" - \".concat((orderInfo&&orderInfo.totalPrice).toLocaleString()),\"\\u0111\"]})]})})})]});};export default Payment;","map":{"version":3,"sources":["D:/devops/frontend/src/components/cart/Payment.js"],"names":["React","Fragment","useEffect","MetaData","CheckoutSteps","useAlert","useDispatch","useSelector","createOrder","clearErrors","useStripe","useElements","CardNumberElement","CardExpiryElement","CardCvcElement","axios","options","style","base","fontSize","invalid","color","Payment","history","alert","stripe","elements","dispatch","state","auth","user","cart","cartItems","shippingInfo","newOrder","error","order","orderItems","orderInfo","JSON","parse","sessionStorage","getItem","itemsPrice","shippingPrice","taxPrice","totalPrice","paymentData","amount","Math","round","submitHandler","e","preventDefault","document","querySelector","disabled","config","headers","post","res","clientSecret","data","client_secret","console","log","confirmCardPayment","payment_method","card","getElement","billing_details","name","email","result","message","paymentIntent","status","paymentInfo","id","push","response","toLocaleString"],"mappings":"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","sourcesContent":["import React, { Fragment, useEffect } from 'react'\r\n\r\nimport MetaData from '../layout/MetaData'\r\nimport CheckoutSteps from './CheckoutSteps'\r\n\r\nimport { useAlert } from 'react-alert'\r\nimport { useDispatch, useSelector } from 'react-redux'\r\nimport { createOrder, clearErrors } from '../../actions/orderActions'\r\n\r\nimport { useStripe, useElements, CardNumberElement, CardExpiryElement, CardCvcElement } from '@stripe/react-stripe-js'\r\n\r\nimport axios from 'axios'\r\n\r\nconst options = {\r\n    style: {\r\n        base: {\r\n            fontSize: '16px'\r\n        },\r\n        invalid: {\r\n            color: '#9e2146'\r\n        }\r\n    }\r\n}\r\n\r\nconst Payment = ({ history }) => {\r\n\r\n    const alert = useAlert();\r\n    const stripe = useStripe();\r\n    const elements = useElements();\r\n    const dispatch = useDispatch();\r\n\r\n    const { user } = useSelector(state => state.auth)\r\n    const { cartItems, shippingInfo } = useSelector(state => state.cart);\r\n    const { error } = useSelector(state => state.newOrder)\r\n\r\n    useEffect(() => {\r\n\r\n        if (error) {\r\n            alert.error(error)\r\n            dispatch(clearErrors())\r\n        }\r\n\r\n    }, [dispatch, alert, error])\r\n\r\n    // cart, ship info\r\n    const order = {\r\n        orderItems: cartItems,\r\n        shippingInfo\r\n    }\r\n\r\n    const orderInfo = JSON.parse(sessionStorage.getItem('orderInfo'));\r\n    if (orderInfo) {\r\n        order.itemsPrice = orderInfo.itemsPrice\r\n        order.shippingPrice = orderInfo.shippingPrice\r\n        order.taxPrice = orderInfo.taxPrice\r\n        order.totalPrice = orderInfo.totalPrice\r\n    }\r\n\r\n    const paymentData = {\r\n        amount: Math.round(orderInfo.totalPrice * 100)  // total price\r\n    }\r\n\r\n    const submitHandler = async (e) => {\r\n        e.preventDefault();\r\n\r\n        document.querySelector('#pay_btn').disabled = true; // tìm kiếm các phần tử dựa trên id\r\n\r\n        let res;\r\n        try {\r\n\r\n            const config = { // config header type\r\n                headers: {\r\n                    'Content-Type': 'application/json'\r\n                }\r\n            }\r\n\r\n            res = await axios.post('/api/v1/payment/process', paymentData, config) // call api paymant process\r\n\r\n            const clientSecret = res.data.client_secret; // client_secret json client\r\n\r\n            console.log(clientSecret);\r\n\r\n            if (!stripe || !elements) { // data input payment stripe\r\n                return;\r\n            }\r\n\r\n            const result = await stripe.confirmCardPayment(clientSecret, { // Xác thực card info\r\n                payment_method: {\r\n                    card: elements.getElement(CardNumberElement),\r\n                    billing_details: { // chi tiết thanh toán\r\n                        name: user.name,\r\n                        email: user.email\r\n                    }\r\n                }\r\n            });\r\n\r\n            if (result.error) {\r\n                alert.error(result.error.message); // return alert error\r\n                document.querySelector('#pay_btn').disabled = false; // disabled btn\r\n            } else {\r\n\r\n                // Thanh toán có được xử lý hay không?\r\n                if (result.paymentIntent.status === 'succeeded') { // if success\r\n\r\n                    order.paymentInfo = {  // payment with info cart, shipInfo\r\n                        id: result.paymentIntent.id,\r\n                        status: result.paymentIntent.status\r\n                    }\r\n\r\n                    dispatch(createOrder(order)) // call createOrder action\r\n\r\n                    history.push('/success') // return page success\r\n                } else {\r\n                    alert.error('Có một số vấn đề trong khi xử lý thanh toán')\r\n                }\r\n            }\r\n\r\n\r\n        } catch (error) { // error server\r\n            document.querySelector('#pay_btn').disabled = false;\r\n            alert.error(error.response.data.message)\r\n        }\r\n    }\r\n\r\n    return (\r\n        <Fragment>\r\n            <MetaData title={'Thông tin thẻ'} />\r\n\r\n            <CheckoutSteps shipping confirmOrder payment />\r\n\r\n            <div className=\"row wrapper\">\r\n                <div className=\"col-10 col-lg-5\">\r\n                    <form className=\"shadow-lg\" onSubmit={submitHandler}>\r\n                        <h1 className=\"mb-4\">Thông tin thẻ</h1>\r\n                        <div className=\"form-group\">\r\n                            <label htmlFor=\"card_num_field\">Số thẻ</label>\r\n                            <CardNumberElement\r\n                                type=\"text\"\r\n                                id=\"card_num_field\"\r\n                                className=\"form-control\"\r\n                                options={options}\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"form-group\">\r\n                            <label htmlFor=\"card_exp_field\">Hạn thẻ</label>\r\n                            <CardExpiryElement\r\n                                type=\"text\"\r\n                                id=\"card_exp_field\"\r\n                                className=\"form-control\"\r\n                                options={options}\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"form-group\">\r\n                            <label htmlFor=\"card_cvc_field\">Số CVC</label>\r\n                            <CardCvcElement\r\n                                type=\"text\"\r\n                                id=\"card_cvc_field\"\r\n                                className=\"form-control\"\r\n                                options={options}\r\n                            />\r\n                        </div>\r\n\r\n\r\n                        <button\r\n                            id=\"pay_btn\"\r\n                            type=\"submit\"\r\n                            className=\"btn btn-block py-3\"\r\n                        >\r\n                            Thanh toán {` - ${(orderInfo && orderInfo.totalPrice).toLocaleString()}`}đ\r\n\r\n                        </button>\r\n\r\n                    </form>\r\n                </div>\r\n            </div>\r\n\r\n        </Fragment>\r\n    )\r\n}\r\n\r\nexport default Payment\r\n"]},"metadata":{},"sourceType":"module"}